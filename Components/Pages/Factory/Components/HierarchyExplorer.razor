@using PackTrack.Models
@using PackTrack.Services
@using PackTrack.Data
@inherits SafeComponent



@inject LiteDbContext Db
@inject IJSRuntime JS
@inject PdfReportService PdfReport


<MudPaper Class="pa-6 glass-panel mt-6" Elevation="2">
    <div class="d-flex align-center gap-3 mb-6">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Secondary" OnClick="OnClose" />
        <div>
            <MudText Typo="Typo.h6">Industrial Hierarchy Explorer</MudText>
            <MudText Typo="Typo.caption">Batch: <span class="monospaced">@Batch.BatchCode</span></MudText>
        </div>
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.LocalPrintshop" Size="Size.Small" OnClick="@(() => DownloadAllLabels())">Export All Labels (PDF)</MudButton>

    </div>

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" Color="Color.Primary">
        <MudTabPanel Text="Batch DNA" Icon="@Icons.Material.Filled.Science">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4 glass-panel-mini h-100" Elevation="0">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3">Chemistry Snapshot</MudText>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Sugar Level (Brix):</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 700;">@Batch.BrixLevel.ToString("F1")°Bx</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Info" Value="@(Batch.BrixLevel * 8)" Size="Size.Small" />
                            
                            <div class="d-flex justify-space-between mt-2">
                                <MudText Typo="Typo.body2">Acidity (pH):</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 700;">@Batch.AcidityPH.ToString("F2")</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Secondary" Value="@(Batch.AcidityPH * 10)" Size="Size.Small" />

                            <div class="d-flex justify-space-between mt-2">
                                <MudText Typo="Typo.body2">Carbonation (CO2):</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 700;">@Batch.CO2Volumes.ToString("F1") vol</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Primary" Value="@(Batch.CO2Volumes * 20)" Size="Size.Small" />
                        </div>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4 glass-panel-mini h-100" Elevation="0">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3">Technical Specifications</MudText>
                        <div class="d-flex flex-column gap-2">
                            <MudText Typo="Typo.caption" Class="label">INGREDIENTS</MudText>
                            <MudText Typo="Typo.body2">@Batch.IngredientsList</MudText>
                            
                            <MudDivider Class="my-2" />
                            
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.caption">Container:</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@Batch.ContainerType (@Batch.CapacityML ml)</MudText>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.caption">Material:</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@Batch.BottleMaterialGrade (@Batch.BottleThicknessMicron μm)</MudText>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.caption">Line ID:</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@Batch.ProductionLineId</MudText>
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <MudTabPanel Text="Pallets" Icon="@Icons.Material.Filled.Inventory">

            <MudGrid>
                @foreach (var p in pallets)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Elevation="4" Class="pallet-card">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.subtitle2">@p.PalletCode</MudText>
                                    <MudText Typo="Typo.caption">Packs: @p.CartonCount | Total: @p.TotalUnits units</MudText>
                                    <MudText Typo="Typo.caption" Class="d-block">Gross: @p.GrossWeight.ToString("F1") kg</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudIconButton Icon="@Icons.Material.Filled.QrCode" Color="Color.Primary" OnClick="@(() => ShowQR(p.PalletCode, "PALLET LABEL"))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Search" Color="Color.Info" OnClick="@(() => SelectPallet(p.Id))" />
                                </CardHeaderActions>
                            </MudCardHeader>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudTabPanel>

        @if (selectedPalletId > 0)
        {
            <MudTabPanel Text="Cartons" Icon="@Icons.Material.Filled.Inbox">
                <MudGrid>
                    @foreach (var c in cartons.Where(x => x.PalletId == selectedPalletId))
                    {
                        <MudItem xs="12" sm="4" md="3">
                            <MudPaper Class="pa-4 carton-box" Elevation="2">
                                <div @onclick="@(() => SelectCarton(c.Id))">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory2" Color="Color.Warning" Size="Size.Small" />
                                    <MudText Typo="Typo.caption" Class="d-block mt-1">@c.CartonCode</MudText>
                                    <MudText Typo="Typo.caption" Style="font-size: 0.7rem;">@c.UnitsPerCarton units | @c.Weight.ToString("F1") kg</MudText>
                                </div>
                                <MudIconButton Icon="@Icons.Material.Filled.QrCode" Color="Color.Warning" Size="Size.Small" Class="qr-btn" OnClick="@(() => ShowQR(c.CartonCode, "CARTON PACK LABEL"))" />
                                @if (selectedCartonId == c.Id)

                                {
                                    <div class="active-indicator"></div>
                                }
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudTabPanel>
        }

        @if (selectedCartonId > 0)
        {
            <MudTabPanel Text="Units (Bottles)" Icon="@Icons.Material.Filled.LocalActivity">
                <MudTable Items="@bottles.Where(x => x.CartonId == selectedCartonId)" Dense="true" Hover="true" FixedHeader="true" Height="300px">
                    <HeaderContent>
                        <MudTh>Unit QR ID</MudTh>
                        <MudTh>pH</MudTh>
                        <MudTh>Brix</MudTh>
                        <MudTh>CO2</MudTh>
                        <MudTh>Temp</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>QR</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd><span class="monospaced-small">@context.BottleId</span></MudTd>
                        <MudTd>@context.pHValue.ToString("F2")</MudTd>
                        <MudTd>@context.BrixLevel.ToString("F1")</MudTd>
                        <MudTd>@context.CO2Volumes.ToString("F1")</MudTd>
                        <MudTd>@context.FillTemperature.ToString("F1")°</MudTd>
                        <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">@context.CurrentStatus</MudChip></MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" OnClick="@(() => ShowQR(context.BottleId, "UNIT LABEL"))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        }


        <MudTabPanel Text="Logistics" Icon="@Icons.Material.Filled.LocalShipping">
            <MudTable Items="@shipments" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>Shipment ID</MudTh>
                    <MudTh>Truck</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Expected Delivery</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>S-@context.Id</MudTd>
                    <MudTd>@context.TruckId</MudTd>
                    <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">@context.Status</MudChip></MudTd>
                    <MudTd>@context.ExpectedDelivery.ToShortDateString()</MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>
    </MudTabs>



</MudPaper>

<MudDialog @bind-Visible="qrVisible" Options="qrOptions">

    <TitleContent>
        <MudText Typo="Typo.h6">@qrTitle</MudText>
    </TitleContent>
    <DialogContent>
        <div class="d-flex flex-column align-center py-4">
            <div id="qrContainer" style="padding: 16px; background: white; border-radius: 8px;"></div>
            <MudText Typo="Typo.h6" Class="mt-4 monospaced">@qrData</MudText>
            <MudText Typo="Typo.caption">INDUSTRIAL GRADE IDENTIFIER</MudText>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="CloseQR">Close</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Print">Simulate Print</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .monospaced { font-family: 'Roboto Mono', monospace; font-weight: 700; color: #594ae2; }
    .monospaced-small { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; }
    
    .qr-btn {
        position: absolute;
        top: 4px;
        right: 4px;
    }

    .pallet-card {
        background: rgba(255,255,255,0.5);
        border-radius: 12px;
        transition: transform 0.2s;
    }
    .pallet-card:hover { transform: scale(1.02); }
    
    .carton-box {
        background: rgba(255,255,255,0.8);
        border: 1px solid #e0e0e0;
        cursor: pointer;
        position: relative;
        text-align: center;
    }
    .carton-box:hover { background: #fff; border-color: #ff9800; }
    
    .active-indicator {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #ff9800;
    }
    .glass-panel-mini {
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
    }
</style>


@code {
    [Parameter] public ProductionBatch Batch { get; set; } = new();


    [Parameter] public EventCallback OnClose { get; set; }

    private List<Pallet> pallets = new();
    private List<Carton> cartons = new();
    private List<BottleUnit> bottles = new();
    private List<Shipment> shipments = new();

    private int selectedPalletId;

    private int selectedCartonId;

    private bool qrVisible;
    private string qrData = "";
    private string qrTitle = "";
    private DialogOptions qrOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override void OnInitialized()
    {
        pallets = Db.Pallets.Find(x => x.BatchId == Batch.Id).ToList();
        cartons = Db.Cartons.Find(x => x.BatchId == Batch.Id).ToList();
        bottles = Db.Bottles.Find(x => x.BatchId == Batch.Id).ToList();
        shipments = Db.Shipments.Find(x => x.BatchId == Batch.Id).ToList();
    }


    private async Task ShowQR(string data, string title)
    {
        qrData = data;
        qrTitle = title;
        qrVisible = true;
        SafeStateHasChanged();
        
        await Task.Delay(100); // Wait for modal render
        if (Disposed) return;

        
        await JS.InvokeVoidAsync("qrGenerator.generate", "qrContainer", data, 200);
    }


    private void CloseQR() => qrVisible = false;

    private void SelectPallet(int id)
    {
        selectedPalletId = id;
        selectedCartonId = 0; // Reset carton selection
    }

    private void SelectCarton(int id)
    {
        selectedCartonId = id;
    }

    private async Task DownloadAllLabels()
    {
        var allCodes = bottles.Select(x => x.BottleId).ToList();
        var bytes = PdfReport.GenerateQrLabels("Industrial Unit", allCodes);
        await DownloadFile($"EcoCola_Labels_{Batch.BatchCode}.pdf", bytes);
    }

    private async Task DownloadFile(string fileName, byte[] bytes)
    {
        using var stream = new MemoryStream(bytes);
        using var streamRef = new DotNetStreamReference(stream);
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}


